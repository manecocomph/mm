<!DOCTYPE html>
<html>
	<head>
		<title>Mindmap version: 0.0.1</title>
		<script src="https://code.jquery.com/jquery-3.1.1.slim.min.js" integrity="sha256-/SIrNqv8h6QGKDuNoLGA4iret+kyesCkHGzVUUV0shc=" crossorigin="anonymous"></script>
		<style type="text/css">
			html, body {
			    margin: 0;
			    height: 100%;
			}

		</style>
	</head>
	<body>
		<div id="stage" style="background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAAT0lEQVQ4T2N8/fr/fwYiADfPP4avX5gIqmQEGSgqyshISOW373//c3EyE1Q3aiDukBwNQ5xhQ/1kAwpsQomaFHnqu3A06+EM/9GcQr+cAgBGqZrSrFyxegAAAABJRU5ErkJggg=='); background-color: rgb(255, 255, 255); width: 3000px; height: 3000px;">
			<span name="node" type="root" style="vertical-align: middle; position: relative; top: 1500px; left:1500px;">
				<span name='leftChildren'></span>
				<span name='leftSvg'></span>
				<span name="actions" style="text-align: center;">
					<span onclick="leftAdd(event)">+</span>
					<input type="text" style="width:0;padding:0;border:0;margin:0;" autofocus>
					<span name="txt" style="border:1px solid green;" contenteditable>goodbye</span>
					<span onclick="rightAdd(event)">+</span>
				</span>
				<span name='rightSvg'></span>
				<span name='rightChildren'></span>
			</span>
		</div>

		<script type="text/javascript">
			var gloablVar = {
				arrayWidth:90,
				arrayHeight:40
			};

			function drawArray(childLeafCountArr, leftOrRight) {
				var count = childLeafCountArr.reduce((a, b) => a + b, 0);
				//console.log("count: " + count);
				var svgWidth = gloablVar.arrayWidth;
				var svgHeight = gloablVar.arrayHeight * (count - 1) + 20;

				var svgHtml = "<svg name='svg' height='" + svgHeight + "' width='" + (svgWidth + 10) + "' style='vertical-align:middle;" + (0 == leftOrRight ? "transform: rotateY(180deg);" : "") + "'>";
				svgHtml += "<defs><marker id='to' style='stroke: #ff7f0e; fill: #ff7f0e; stroke-width: 1.5px;' viewBox='0 0 10 10' refX='0' refY='5' markerWidth='6' markerHeight='6' orient='auto'><path d='M 0 0 L 10 5 L 0 10 z'></path></marker></defs>";
				svgHtml += "<g transform='translate(0,0)'>";

				var fromHeight = svgHeight/2;
				var virtualSum = 0;
				for (var i = 0; i < childLeafCountArr.length; i++) {
					var toHeight = 10 + (virtualSum + (childLeafCountArr[i] - 1)/ 2) * gloablVar.arrayHeight;
					svgHtml += "<path style='stroke: #ff7f0e; fill: none; stroke-width: 1.5px;' d='M0," + fromHeight + "C" + svgWidth/2 + "," + fromHeight + " " + svgWidth/2 + "," + toHeight + " " + svgWidth + "," + toHeight + "' marker-end='url(#to)' />";
					virtualSum += childLeafCountArr[i];
				}

				svgHtml += "</g>";
				svgHtml += "</svg>";

				//console.log(svgHtml);
				return svgHtml;
			}

			function rightAddRedraw(node) {
				//console.log(node.attr("type"));
				if ("root" == node.attr("type")) {
					var childNodes = node.children("span[name='rightChildren']").children("span");
					var childLeafCountArr = [];
					for (var i = 0; i < childNodes.length; i++) {
						if ("leaf" === $(childNodes[i]).attr("type")) {
							childLeafCountArr.push(1);
						} else {
							childLeafCountArr.push($(childNodes[i]).find("span[type='leaf']").length);
						}
					}

					var virtualSum = 0;
					var leafTotalCount = childLeafCountArr.reduce((a, b) => a + b, 0);
					for (var i = 0; i < childLeafCountArr.length; i++) {
						//console.log(virtualSum + (childLeafCountArr[i] - leafTotalCount)/2);
						$(childNodes[i]).css("top", (gloablVar.arrayHeight * (virtualSum + (childLeafCountArr[i] - leafTotalCount)/2 - (childLeafCountArr[i] - 1)/2))+ "px");
						virtualSum += childLeafCountArr[i];
					};
					
					console.log(childLeafCountArr);
					node.find("> span[name='rightSvg']").html(drawArray(childLeafCountArr, 1));
				} else {
					rightAddRedraw(node.parent().closest("span[name='node']"));

					var childNodes = node.children("span[name='children']").children("span");
					var childLeafCountArr = [];
					for (var i = 0; i < childNodes.length; i++) {
						if ("leaf" === $(childNodes[i]).attr("type")) {
							childLeafCountArr.push(1);
						} else {
							childLeafCountArr.push($(childNodes[i]).find("span[type='leaf']").length);
						}
					}

					var virtualSum = 0;
					var leafTotalCount = childLeafCountArr.reduce((a, b) => a + b, 0);
					for (var i = 0; i < childLeafCountArr.length; i++) {
						$(childNodes[i]).css("top", (gloablVar.arrayHeight * (virtualSum + (childLeafCountArr[i] - leafTotalCount)/2 - (childLeafCountArr[i] - 1)/2 + (leafTotalCount - 1)/2))+ "px");
						virtualSum += childLeafCountArr[i];
					};

					node.find("> span[name='svg']").html(drawArray(childLeafCountArr, 1));
				}
			}

			function leftAddRedraw(node) {
				//console.log(node.attr("type"));
				if ("root" == node.attr("type")) {
					var childNodes = node.children("span[name='leftChildren']").children("span");
					var childLeafCountArr = [];
					for (var i = 0; i < childNodes.length; i++) {
						if ("leaf" === $(childNodes[i]).attr("type")) {
							childLeafCountArr.push(1);
						} else {
							childLeafCountArr.push($(childNodes[i]).find("span[type='leaf']").length);
						}
					}

					var virtualSum = 0;
					var leafTotalCount = childLeafCountArr.reduce((a, b) => a + b, 0);
					for (var i = 0; i < childLeafCountArr.length; i++) {
						//console.log(virtualSum + (childLeafCountArr[i] - leafTotalCount)/2);
						$(childNodes[i]).css("top", (gloablVar.arrayHeight * (virtualSum + (childLeafCountArr[i] - leafTotalCount)/2 - (childLeafCountArr[i] - 1)/2))+ "px");
						virtualSum += childLeafCountArr[i];
					};
					
					console.log(childLeafCountArr);
					node.find("> span[name='leftSvg']").html(drawArray(childLeafCountArr, 0));
				} else {
					leftAddRedraw(node.parent().closest("span[name='node']"));

					var childNodes = node.children("span[name='children']").children("span");
					var childLeafCountArr = [];
					for (var i = 0; i < childNodes.length; i++) {
						if ("leaf" === $(childNodes[i]).attr("type")) {
							childLeafCountArr.push(1);
						} else {
							childLeafCountArr.push($(childNodes[i]).find("span[type='leaf']").length);
						}
					}

					var virtualSum = 0;
					var leafTotalCount = childLeafCountArr.reduce((a, b) => a + b, 0);
					for (var i = 0; i < childLeafCountArr.length; i++) {
						$(childNodes[i]).css("top", (gloablVar.arrayHeight * (virtualSum + (childLeafCountArr[i] - leafTotalCount)/2 - (childLeafCountArr[i] - 1)/2 + (leafTotalCount - 1)/2))+ "px");
						virtualSum += childLeafCountArr[i];
					};

					node.find("> span[name='svg']").html(drawArray(childLeafCountArr, 0));
				}
			}

			function newNodeHtml(leftOrRight) {
				if (0 === leftOrRight) {//left
					return "<span name='node' type='leaf' style='position:absolute;white-space: nowrap;'>"
									+ "<span name='children'></span>"
									+ "<span name='actions'>"
									+ 		"<span onclick='leftAdd(event)' style='margin:4px;'>+</span>"
									+       "<input type='text' style='width:0;padding:0;border:0;margin:0;'>"
									+		"<span name='txt' style='border:1px solid green;' contenteditable>new</span>"
									+ "</span>"
									+ "<span name='svg'></span>"
							+ "</span>";
				} else {//right
					return  "<span name='node' type='leaf' style='position:absolute;'>"
									+ "<span name='actions'>"
									+	 	"<input type='text' style='width:0;padding:0;border:0;margin:0;'>"
									+		"<span name='txt' style='border:1px solid green;' contenteditable>new</span>"
									+ 		"<span onclick='rightAdd(event)' style='margin:4px;'>+</span>"
									+  "</span>"
								  	+ "<span name='svg'></span>"
								  	+ "<span name='children'></span>"
							+ "</span>";
				}
			}

			function rightAdd(event) {
				var node  = $(event.target).closest("span[name='node']");
				if ("leaf" === node.attr("type")) {
					node.attr("type", "stem");
				}
				
				if ("root" == node.attr("type")) {
					node.find("> span[name='rightChildren']").append(newNodeHtml(1));
				} else {
					node.find("> span[name='children']").append(newNodeHtml(1));
				}
				rightAddRedraw(node);
			}

			function leftAdd(event) {
				var node  = $(event.target).closest("span[name='node']");
				if ("leaf" === node.attr("type")) {
					node.attr("type", "stem");
				}
				
				if ("root" == node.attr("type")) {
					node.find("> span[name='leftChildren']").append(newNodeHtml(0));
				} else {
					node.find("> span[name='children']").append(newNodeHtml(0));
				}
				leftAddRedraw(node);
			}
		</script>
	</body>
</html>
